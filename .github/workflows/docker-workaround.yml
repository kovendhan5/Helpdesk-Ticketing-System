name: ğŸ”§ Docker Access Workaround

on:
  workflow_dispatch:

jobs:
  docker-workaround:
    name: ğŸ”§ Docker Access Workaround
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸ”‘ Add VM to known hosts
        run: |
          ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ” Check Current Docker Status
        run: |
          echo "ğŸ” Checking current Docker status..."
          ssh ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} "
            echo 'Current user: \$(whoami)'
            echo 'Current groups: \$(groups)'
            echo 'Docker version: \$(docker --version)'
            echo 'Testing Docker access:'
            docker ps 2>&1 || echo 'Docker permission denied (expected)'
          "

      - name: ğŸ“‹ Docker Permission Analysis
        run: |
          echo "ğŸ“‹ Analyzing Docker permission situation..."
          ssh ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} "
            echo 'Docker socket permissions:'
            ls -la /var/run/docker.sock
            echo 'Docker group info:'
            getent group docker || echo 'Docker group not found'
            echo 'Current user ID:'
            id \$(whoami)
          "

      - name: ğŸ”§ Alternative Docker Setup Instructions
        run: |
          echo "ğŸ”§ Docker Permission Issue Detected"
          echo "=================================="
          echo ""
          echo "âŒ The user cannot be added to docker group without sudo password access."
          echo ""
          echo "ğŸ” Alternative solutions:"
          echo ""
          echo "1ï¸âƒ£ **Manual VM Access Required** (Recommended):"
          echo "   â€¢ SSH into VM manually: ssh ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}"
          echo "   â€¢ Run: sudo usermod -aG docker \$(whoami)"
          echo "   â€¢ Logout and login again"
          echo "   â€¢ Test: docker ps"
          echo ""
          echo "2ï¸âƒ£ **Use Docker with sudo in deployment** (Alternative):"
          echo "   â€¢ Modify deployment workflow to use 'sudo docker' commands"
          echo "   â€¢ This requires passwordless sudo for docker commands"
          echo ""
          echo "3ï¸âƒ£ **Contact VM Administrator** (If not your VM):"
          echo "   â€¢ Ask admin to add user to docker group"
          echo "   â€¢ Or configure passwordless sudo for docker commands"

      - name: ğŸš€ Modified Deployment Option
        run: |
          echo "ğŸš€ Modified Deployment Option Available"
          echo "======================================"
          echo ""
          echo "ğŸ’¡ **Alternative Approach**: We can create a modified deployment workflow"
          echo "   that uses 'sudo docker' commands instead of direct docker access."
          echo ""
          echo "âš ï¸  **Requirements for this to work**:"
          echo "   â€¢ User must have passwordless sudo for docker commands, OR"
          echo "   â€¢ Manual docker group addition via VM console access"
          echo ""
          echo "ğŸ” **Next Steps - Choose One**:"
          echo ""
          echo "A) **Manual Fix** (Recommended if you have VM access):"
          echo "   1. Access VM via Google Cloud Console (SSH button)"
          echo "   2. Run: sudo usermod -aG docker \$(whoami)"
          echo "   3. Logout/login or restart VM"
          echo "   4. Run robust deployment workflow"
          echo ""
          echo "B) **Use Sudo Docker Deployment** (If manual access not possible):"
          echo "   1. We'll create a sudo-docker deployment workflow"
          echo "   2. Configure passwordless sudo for docker (if possible)"
          echo ""
          echo "ğŸ“Š **Recommendation**: Use Option A (manual fix) as it's most reliable."

      - name: ğŸ“Š Summary
        run: |
          echo "ğŸ“Š Docker Permission Fix Summary"
          echo "==============================="
          echo "âŒ Cannot automatically add user to docker group (requires sudo password)"
          echo "âœ… Identified alternative solutions"
          echo "ğŸ¯ **Recommended Action**: Manual VM access to fix docker permissions"
          echo ""
          echo "ğŸ”— **VM Access**: Use Google Cloud Console SSH button for VM access"
          echo "ğŸ”— **VM IP**: ${{ secrets.VM_HOST }}"
          echo "ğŸ”— **VM User**: ${{ secrets.VM_USER }}"
