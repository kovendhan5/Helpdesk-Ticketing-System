name: ğŸš€ Deploy Helpdesk System (Sudo-Free)

on:
  workflow_dispatch:
    inputs:
      deploy_environment:
        description: "Environment to deploy to"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - staging

jobs:
  deploy:
    name: ğŸš€ Deploy to GCP VM (No Sudo)
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Validate secrets
        run: |
          echo "ğŸ” Validating GitHub Secrets..."

          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "âŒ SSH_PRIVATE_KEY secret is not set or empty"
            exit 1
          fi

          if [ -z "${{ secrets.VM_HOST }}" ]; then
            echo "âŒ VM_HOST secret is not set or empty"
            exit 1
          fi

          if [ -z "${{ secrets.VM_USER }}" ]; then
            echo "âŒ VM_USER secret is not set or empty"
            exit 1
          fi

          echo "âœ… All required secrets are configured"
          echo "ğŸ¯ Target server: ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}"

      - name: ğŸ”§ Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸ”‘ Add VM to known hosts
        run: |
          echo "Adding ${{ secrets.VM_HOST }} to known hosts..."
          ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts
          echo "âœ… Known hosts updated"

      - name: ğŸ§ª Test SSH Connection
        run: |
          echo "ğŸ§ª Testing SSH connection..."
          ssh -o ConnectTimeout=30 -o StrictHostKeyChecking=no ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} "
            echo 'âœ… SSH connection successful!'
            echo 'User: $(whoami)'
            echo 'Home: $HOME'
            echo 'Working directory: $(pwd)'
            echo 'Docker version:'
            docker --version 2>/dev/null || echo 'âŒ Docker not available'
            echo 'Docker Compose version:'
            docker-compose --version 2>/dev/null || echo 'âŒ Docker Compose not available'
            echo 'Docker group membership:'
            groups $(whoami) | grep -q docker && echo 'âœ… User in docker group' || echo 'âš ï¸ User NOT in docker group'
          "

      - name: ğŸš€ Deploy Application (Sudo-Free)
        run: |
          ssh ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} "
            set -e
            
            echo 'ğŸš€ Starting sudo-free deployment process...'
            echo 'ğŸ“… Timestamp: \$(date)'
            
            # Clean up previous installation (user space only)
            cd ~
            echo 'ğŸ§¹ Cleaning up previous installation...'
            rm -rf Helpdesk-Ticketing-System 2>/dev/null || true
            rm -rf .git .gitconfig .gitignore 2>/dev/null || true
            
            # Clear any git locks (user space only)
            pkill -f git -u \$(whoami) 2>/dev/null || true
            sleep 2
            
            # Clone repository with fresh start
            echo 'ğŸ“¥ Cloning repository...'
            git clone https://github.com/kovendhan5/Helpdesk-Ticketing-System.git
            cd Helpdesk-Ticketing-System
            
            # Show current directory and files for debugging
            echo 'ğŸ“‚ Repository cloned successfully'
            echo 'ğŸ“‚ Current directory: \$(pwd)'
            echo 'ğŸ“ Files in repository:'
            ls -la | head -20
            
            # Verify required files exist
            echo 'ğŸ” Verifying required files...'
            [ -f 'docker-compose.prod.yml' ] && echo 'âœ… docker-compose.prod.yml found' || (echo 'âŒ docker-compose.prod.yml missing' && exit 1)
            [ -d 'backend' ] && echo 'âœ… backend directory found' || (echo 'âŒ backend directory missing' && exit 1)
            [ -d 'frontend' ] && echo 'âœ… frontend directory found' || (echo 'âŒ frontend directory missing' && exit 1)
            
            # Verify Docker is available (should already be installed)
            echo 'ğŸ³ Checking Docker availability...'
            if ! command -v docker &> /dev/null; then
              echo 'âŒ Docker is not installed or not in PATH'
              echo 'ğŸ‘‰ Please install Docker on the VM first'
              exit 1
            else
              echo 'âœ… Docker is available: \$(docker --version)'
            fi
            
            # Verify Docker Compose is available (should already be installed)
            echo 'ğŸ³ Checking Docker Compose availability...'
            if ! command -v docker-compose &> /dev/null; then
              echo 'âŒ Docker Compose is not installed or not in PATH'
              echo 'ğŸ‘‰ Please install Docker Compose on the VM first'
              exit 1
            else
              echo 'âœ… Docker Compose is available: \$(docker-compose --version)'
            fi
            
            # Test Docker permissions
            echo 'ğŸ‘¥ Testing Docker permissions...'
            if docker ps >/dev/null 2>&1; then
              echo 'âœ… Docker commands work without sudo'
            else
              echo 'âŒ Docker commands require sudo - this will fail'
              echo 'ğŸ‘‰ Please add user to docker group: sudo usermod -aG docker \$(whoami)'
              echo 'ğŸ‘‰ Then logout and login again'
              exit 1
            fi
            
            # Set up application directory in user space
            echo 'ğŸ“ Setting up application directory...'
            rm -rf ~/helpdesk-app 2>/dev/null || true
            mkdir -p ~/helpdesk-app
            
            # Copy files safely
            echo 'ğŸ“‹ Copying application files...'
            cp -r backend frontend ~/helpdesk-app/
            cp docker-compose.prod.yml ~/helpdesk-app/
            cp .env.production ~/helpdesk-app/ 2>/dev/null || echo 'âš ï¸ .env.production not found, using defaults'
            
            echo 'âœ… Files copied successfully'
            echo 'ğŸ“ Application directory contents:'
            ls -la ~/helpdesk-app/
            
            # Deploy with Docker Compose
            echo 'ğŸš€ Deploying with Docker Compose...'
            cd ~/helpdesk-app
            
            # Stop existing containers (if any)
            echo 'ğŸ›‘ Stopping existing containers...'
            if docker-compose -f docker-compose.prod.yml ps -q | grep -q .; then
              docker-compose -f docker-compose.prod.yml down
              echo 'âœ… Existing containers stopped'
            else
              echo 'ğŸ“ No existing containers to stop'
            fi
            
            # Clean up old images and containers (user accessible only)
            echo 'ğŸ§¹ Cleaning up old containers and images...'
            docker container prune -f || true
            docker image prune -f || true
            docker volume prune -f || true
            
            # Build and start containers
            echo 'ğŸ—ï¸ Building and starting containers...'
            docker-compose -f docker-compose.prod.yml build --no-cache
            docker-compose -f docker-compose.prod.yml up -d --remove-orphans
            
            # Wait for services to start
            echo 'â³ Waiting for services to start...'
            sleep 30
            
            # Check container status
            echo 'ğŸ“Š Container Status:'
            docker ps -a
            
            # Check if containers are running
            RUNNING_CONTAINERS=\$(docker ps --format 'table {{.Names}}\t{{.Status}}' | grep -c 'Up' || echo '0')
            echo \"ğŸ“Š Running containers: \$RUNNING_CONTAINERS\"
            
            # Check container logs for any immediate issues
            echo 'ğŸ“‹ Recent container logs:'
            docker-compose -f docker-compose.prod.yml logs --tail=10
            
            # Health check
            echo 'ğŸ¥ Performing health check...'
            sleep 10
            
            # Test if the application is responding
            if curl -f http://localhost:3001/api/health >/dev/null 2>&1; then
              echo 'âœ… Backend health check passed'
            else
              echo 'âš ï¸ Backend health check failed or endpoint unavailable'
            fi
            
            if curl -f http://localhost:80 >/dev/null 2>&1; then
              echo 'âœ… Frontend health check passed'
            else
              echo 'âš ï¸ Frontend health check failed or endpoint unavailable'
            fi
            
            echo 'âœ… Deployment completed successfully!'
            echo 'ğŸŒ Access your application at: http://34.173.186.108'
            echo 'ğŸ“Š Check container status with: docker ps'
            echo 'ğŸ“‹ View logs with: docker-compose -f ~/helpdesk-app/docker-compose.prod.yml logs'
            echo 'ğŸ”„ Restart containers with: docker-compose -f ~/helpdesk-app/docker-compose.prod.yml restart'
          "

      - name: ğŸ“Š Deployment Summary
        if: always()
        run: |
          echo "ğŸ“Š Deployment Summary"
          echo "===================="
          echo "ğŸ¯ Target: ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}"
          echo "ğŸ“… Time: $(date)"
          echo "ğŸš€ Workflow: Sudo-Free Deployment"
          echo "âœ… Deployment process completed"
          echo ""
          echo "ğŸŒ Application should be accessible at: http://34.173.186.108"
          echo "ğŸ“‹ Check deployment status by connecting to VM and running:"
          echo "   docker ps"
          echo "   docker-compose -f ~/helpdesk-app/docker-compose.prod.yml logs"
