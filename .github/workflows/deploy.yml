name: ğŸš€ Deploy Helpdesk System (DISABLED)

on:
  # Disabled automatic deployment - use deploy-robust.yml instead
  # push:
  #   branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: ğŸš€ Deploy to GCP VM
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Validate secrets
        run: |
          echo "ğŸ” Validating GitHub Secrets..."

          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "âŒ SSH_PRIVATE_KEY secret is not set or empty"
            echo "ğŸ‘‰ Go to Settings â†’ Secrets and variables â†’ Actions"
            echo "ğŸ‘‰ Add SSH_PRIVATE_KEY with content from: cat ~/key (on VM)"
            exit 1
          fi

          if [ -z "${{ secrets.VM_HOST }}" ]; then
            echo "âŒ VM_HOST secret is not set or empty"
            echo "ğŸ‘‰ Should be: 34.173.186.108"
            exit 1
          fi

          if [ -z "${{ secrets.VM_USER }}" ]; then
            echo "âŒ VM_USER secret is not set or empty"
            echo "ğŸ‘‰ Should be: kovendhan2535"
            exit 1
          fi

          echo "âœ… All required secrets are configured"
          echo "ğŸ¯ Target server: ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}"

      - name: ğŸ”§ Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸ”‘ Add VM to known hosts
        run: |
          echo "Adding ${{ secrets.VM_HOST }} to known hosts..."
          ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts
          echo "âœ… Known hosts updated"

      - name: ğŸ§ª Test SSH Connection
        run: |
          echo "ğŸ§ª Testing SSH connection to ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}..."
          ssh -o ConnectTimeout=30 -o StrictHostKeyChecking=no ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} "
            echo 'SSH connection successful!'
            echo 'User: $(whoami)'
            echo 'Home: $HOME'
            echo 'Working directory: $(pwd)'
            echo 'Docker status:'
            docker --version || echo 'Docker not installed'
          "

      - name: ğŸš€ Deploy Application
        run: |
          ssh ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} "
            set -e
            
            echo 'ğŸš€ Starting sudo-free deployment process...'
            
            # Clean up previous installation (user space only)
            cd ~
            rm -rf Helpdesk-Ticketing-System
            rm -rf .git .gitconfig .gitignore 2>/dev/null || true
            
            # Clear any git locks (user space only)
            pkill -f git -u \$(whoami) 2>/dev/null || true
            
            # Clone repository with fresh start
            echo 'ğŸ“¥ Cloning repository...'
            git clone https://github.com/kovendhan5/Helpdesk-Ticketing-System.git
            cd Helpdesk-Ticketing-System
            
            # Show current directory and files for debugging
            echo 'ğŸ“‚ Current directory: \$(pwd)'
            echo 'ğŸ“ Files in repository:'
            ls -la
            
            # Verify Docker is available (should already be installed)
            echo 'ğŸ³ Checking Docker availability...'
            if ! command -v docker &> /dev/null; then
              echo 'âŒ Docker is not installed or not in PATH'
              echo 'ğŸ‘‰ Please install Docker on the VM first'
              exit 1
            else
              echo 'âœ… Docker is available: \$(docker --version)'
            fi
            
            # Verify Docker Compose is available (should already be installed)
            echo 'ğŸ³ Checking Docker Compose availability...'
            if ! command -v docker-compose &> /dev/null; then
              echo 'âŒ Docker Compose is not installed or not in PATH'
              echo 'ğŸ‘‰ Please install Docker Compose on the VM first'
              exit 1
            else
              echo 'âœ… Docker Compose is available: \$(docker-compose --version)'
            fi
            
            # Check if user is in docker group
            echo 'ğŸ‘¥ Checking Docker permissions...'
            if groups \$(whoami) | grep -q docker; then
              echo 'âœ… User is in docker group'
            else
              echo 'âš ï¸  User is not in docker group, but will try anyway'
            fi
            
            # Set up application directory in user space
            echo 'ğŸ“ Setting up application directory...'
            mkdir -p ~/helpdesk-app
            
            # Copy files safely
            echo 'ğŸ“‹ Copying application files...'
            cp -r backend frontend ~/helpdesk-app/
            
            # Always copy the docker-compose file from repository
            cp docker-compose.prod.yml ~/helpdesk-app/
            echo 'âœ… Files copied successfully'
            
            # Show what we have
            echo 'ğŸ“ Application directory contents:'
            ls -la ~/helpdesk-app/
            
            # Deploy with Docker Compose
            echo 'ğŸš€ Deploying with Docker Compose...'
            cd ~/helpdesk-app
            
            # Stop existing containers (if any)
            echo 'ğŸ›‘ Stopping existing containers...'
            docker-compose -f docker-compose.prod.yml down || true
            
            # Clean up old images and containers (user accessible only)
            echo 'ğŸ§¹ Cleaning up old containers and images...'
            docker container prune -f || true
            docker image prune -f || true
            
            # Build and start containers
            echo 'ğŸ—ï¸  Building and starting containers...'
            docker-compose -f docker-compose.prod.yml up -d --build --remove-orphans
            
            # Wait for services to start
            echo 'â³ Waiting for services to start...'
            sleep 30
            
            # Check container status
            echo 'ğŸ“Š Container Status:'
            docker ps -a
            
            # Check container logs for any immediate issues
            echo 'ğŸ“‹ Recent container logs:'
            docker-compose -f docker-compose.prod.yml logs --tail=20
            
            echo 'âœ… Deployment completed successfully!'
            echo 'ğŸŒ Access your application at: http://34.173.186.108'
            echo 'ğŸ“Š Check container status with: docker ps'
            echo 'ğŸ“‹ View logs with: docker-compose -f ~/helpdesk-app/docker-compose.prod.yml logs'
          "
