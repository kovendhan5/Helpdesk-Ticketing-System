name: Deploy Helpdesk System

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Deploy to Production VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 900s
          script: |
            echo "=== Starting Deployment ==="

            # Clean workspace
            cd /home/kovendhan2535
            rm -rf helpdesk-app
            mkdir helpdesk-app
            cd helpdesk-app

            # Get latest code
            git clone https://github.com/kovendhan5/Helpdesk-Ticketing-System.git .

            # Create environment file
            cat > .env << EOF
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            FRONTEND_PORT=80
            API_URL=http://${{ secrets.VM_HOST }}:3001
            EOF

            # Stop and clean up
            docker-compose down 2>/dev/null || true
            docker rm -f helpdesk-postgres helpdesk-backend helpdesk-frontend 2>/dev/null || true

            # Deploy
            echo "=== Building and Starting Services ==="
            docker-compose up -d --build

            # Wait and check
            sleep 30
            echo "=== Deployment Status ==="
            docker ps
            echo "=== Service Health ==="
            curl -f http://localhost/ >/dev/null 2>&1 && echo "✅ Frontend: OK" || echo "❌ Frontend: FAILED"
            curl -f http://localhost:3001/health >/dev/null 2>&1 && echo "✅ Backend: OK" || echo "❌ Backend: FAILED"
            echo "=== Deployment Complete ==="
