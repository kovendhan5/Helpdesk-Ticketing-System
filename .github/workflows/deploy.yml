name: Deploy Helpdesk System

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Deploy to Production VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 900s
          script: |
            echo "=== Starting Deployment ==="

            # Clean workspace
            cd /home/kovendhan2535
            rm -rf helpdesk-app
            mkdir helpdesk-app
            cd helpdesk-app

            # Get latest code
            git clone https://github.com/kovendhan5/Helpdesk-Ticketing-System.git .

            # Create environment file
            cat > .env << EOF
            DB_PASSWORD=${{ secrets.DB_PASSWORD }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            FRONTEND_PORT=80
            API_URL=http://${{ secrets.VM_HOST }}:3001
            EOF

            # Stop and clean up
            docker-compose down 2>/dev/null || true
            docker rm -f helpdesk-postgres helpdesk-backend helpdesk-frontend 2>/dev/null || true
            echo "ğŸ§¹ Previous containers stopped and removed."

            # Forcefully free up port 80
            echo "ğŸ”“ Attempting to free up port 80..."
            if sudo lsof -t -i:80 > /dev/null; then
              echo "âš ï¸ Port 80 is in use. Attempting to kill the process..."
              sudo kill -9 $(sudo lsof -t -i:80) || echo "Failed to kill process on port 80, or port was already free."
              sleep 5 # Give a moment for the port to be released
              if sudo lsof -t -i:80 > /dev/null; then
                echo "âŒ CRITICAL: Failed to free port 80. Another process is still using it."
                # Optionally, try to find out what it is
                sudo lsof -i:80
                # exit 1 # Decide if this should be a fatal error for the script
              else
                echo "âœ… Port 80 should now be free."
              fi
            else
              echo "âœ… Port 80 is already free."
            fi

            # Build services
            echo "ğŸ› ï¸ Building services..."
            if ! docker-compose build; then
              echo "âŒ Docker build failed!"
              echo "=== Backend Logs (if any) ==="
              docker-compose logs --tail=50 backend || echo "No backend logs."
              echo "=== Frontend Logs (if any) ==="
              docker-compose logs --tail=50 frontend || echo "No frontend logs."
              exit 1
            fi
            echo "âœ… Services built successfully."

            # Start services
            echo "ğŸš€ Starting services..."
            if ! docker-compose up -d; then
              echo "âŒ Docker compose up failed!"
              echo "=== Backend Logs ==="
              docker-compose logs --tail=50 backend || echo "No backend logs."
              echo "=== Frontend Logs ==="
              docker-compose logs --tail=50 frontend || echo "No frontend logs."
              exit 1
            fi
            echo "âœ… Services started."

            # Wait for services to initialize
            echo "â³ Waiting for services to initialize (30 seconds)..."
            sleep 30

            echo "=== Deployment Status (docker ps) ==="
            docker ps -a

            echo "=== Detailed Container Logs ==="
            echo "--- Postgres Logs ---"
            docker-compose logs --tail=30 postgres || echo "No postgres logs."
            echo "--- Backend Logs ---"
            docker-compose logs --tail=50 backend || echo "No backend logs."
            echo "--- Frontend Logs ---"
            docker-compose logs --tail=50 frontend || echo "No frontend logs."

            echo "=== Service Health Check ==="
            FRONTEND_OK=false
            if curl -s -f http://localhost/ >/dev/null 2>&1; then
              echo "âœ… Frontend: OK (Responded to http://localhost/)"
              FRONTEND_OK=true
            else
              echo "âŒ Frontend: FAILED (Could not reach http://localhost/)"
            fi

            BACKEND_OK=false
            if curl -s -f http://localhost:3001/health >/dev/null 2>&1; then
              echo "âœ… Backend: OK (Responded to http://localhost:3001/health)"
              BACKEND_OK=true
            else
              echo "âŒ Backend: FAILED (Could not reach http://localhost:3001/health)"
            fi

            if $FRONTEND_OK && $BACKEND_OK; then
              echo "ğŸ‰ğŸ‰ğŸ‰ Deployment SUCCEEDED! ğŸ‰ğŸ‰ğŸ‰"
            else
              echo "ğŸ”¥ğŸ”¥ğŸ”¥ Deployment FAILED! Check logs above. ğŸ”¥ğŸ”¥ğŸ”¥"
              exit 1
            fi
            echo "=== Deployment Script Complete ==="
