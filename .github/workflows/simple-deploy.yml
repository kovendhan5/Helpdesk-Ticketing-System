name: Simple Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Simple Deploy
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          timeout: 300s
          script: |
            echo "=== SIMPLE DEPLOYMENT ==="

            # Go to app directory
            cd /home/kovendhan2535/helpdesk || {
              echo "Creating helpdesk directory..."
              mkdir -p /home/kovendhan2535/helpdesk
              cd /home/kovendhan2535/helpdesk
            }

            # Update code
            echo "Updating code..."
            if [ -d ".git" ]; then
              git pull origin main
            else
              git clone --depth 1 https://github.com/kovendhan5/Helpdesk-Ticketing-System.git .
            fi

            # Stop and restart containers
            echo "Restarting containers..."
            docker-compose -f docker-compose.simple.yml down
            docker-compose -f docker-compose.simple.yml up -d

            # Show status
            echo "=== STATUS ==="
            docker ps

            echo "=== LOGS ==="
            sleep 10
            docker-compose -f docker-compose.simple.yml logs --tail=10
