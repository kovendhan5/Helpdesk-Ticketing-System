name: ğŸ” SSH Connection Diagnostics

on:
  workflow_dispatch:

jobs:
  debug-ssh:
    name: ğŸ” Debug SSH Connection
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Check GitHub Secrets
        run: |
          echo "ğŸ” Checking GitHub Secrets..."
          
          # Check if secrets exist (without revealing values)
          if [ -n "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "âœ… SSH_PRIVATE_KEY is set (length: ${#PRIVATE_KEY} chars)"
            echo "ğŸ”‘ Key starts with: $(echo '${{ secrets.SSH_PRIVATE_KEY }}' | head -c 30)..."
            echo "ğŸ”‘ Key ends with: ...$(echo '${{ secrets.SSH_PRIVATE_KEY }}' | tail -c 30)"
          else
            echo "âŒ SSH_PRIVATE_KEY is empty or not set"
          fi
          
          if [ -n "${{ secrets.VM_HOST }}" ]; then
            echo "âœ… VM_HOST is set: ${{ secrets.VM_HOST }}"
          else
            echo "âŒ VM_HOST is empty or not set"
          fi
          
          if [ -n "${{ secrets.VM_USER }}" ]; then
            echo "âœ… VM_USER is set: ${{ secrets.VM_USER }}"
          else
            echo "âŒ VM_USER is empty or not set"
          fi
        env:
          PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸ”§ Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: ğŸ”‘ SSH Key Validation
        run: |
          echo "ğŸ” Validating SSH key format..."
          
          # Check if SSH agent is running
          ssh-add -l && echo "âœ… SSH agent has keys loaded" || echo "âŒ SSH agent has no keys"
          
          # Test SSH key format
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | head -1 | grep -q "BEGIN" && echo "âœ… Key starts with BEGIN" || echo "âŒ Key doesn't start with BEGIN"
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | tail -1 | grep -q "END" && echo "âœ… Key ends with END" || echo "âŒ Key doesn't end with END"

      - name: ğŸŒ Network Connectivity Test
        run: |
          echo "ğŸŒ Testing network connectivity to VM..."
          
          # Test if host is reachable
          ping -c 3 ${{ secrets.VM_HOST }} && echo "âœ… Host is reachable" || echo "âŒ Host is unreachable"
          
          # Test SSH port
          nc -zv ${{ secrets.VM_HOST }} 22 && echo "âœ… SSH port 22 is open" || echo "âŒ SSH port 22 is closed"

      - name: ğŸ”‘ Add VM to known hosts
        run: |
          echo "ğŸ”‘ Adding VM to known hosts..."
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VM_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
          echo "âœ… Known hosts updated"
          
          # Show what was added
          echo "ğŸ“‹ Known hosts entries for VM:"
          grep "${{ secrets.VM_HOST }}" ~/.ssh/known_hosts || echo "âŒ No entry found"

      - name: ğŸ§ª SSH Connection Test (Verbose)
        run: |
          echo "ğŸ§ª Testing SSH connection with verbose output..."
          
          # Try connecting with verbose SSH
          ssh -vvv -o ConnectTimeout=10 -o StrictHostKeyChecking=no ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} "echo 'SSH connection successful!' && whoami && pwd" || {
            echo "âŒ SSH connection failed"
            echo "ğŸ” Possible causes:"
            echo "  1. Wrong SSH private key"
            echo "  2. Key not added to VM's authorized_keys"
            echo "  3. Wrong username or hostname"
            echo "  4. VM firewall blocking SSH"
            echo "  5. VM is down or unreachable"
            exit 1
          }

      - name: ğŸ” VM Environment Check
        if: success()
        run: |
          echo "ğŸ” Checking VM environment..."
          ssh ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }} "
            echo 'ğŸ“‹ VM Information:'
            echo 'User: \$(whoami)'
            echo 'Home: \$HOME'
            echo 'Working directory: \$(pwd)'
            echo 'OS: \$(cat /etc/os-release | grep PRETTY_NAME)'
            echo 'Docker: \$(docker --version 2>/dev/null || echo 'Not installed')'
            echo 'Docker Compose: \$(docker-compose --version 2>/dev/null || echo 'Not installed')'
            echo 'Git: \$(git --version 2>/dev/null || echo 'Not installed')'
            echo 'User groups: \$(groups)'
            echo 'SSH authorized keys:'
            ls -la ~/.ssh/authorized_keys 2>/dev/null || echo 'No authorized_keys file'
            echo 'Disk space:'
            df -h / | head -2
            echo 'Memory:'
            free -h | head -2
          "

      - name: ğŸ“Š Diagnosis Summary
        if: always()
        run: |
          echo "ğŸ“Š SSH Connection Diagnosis Summary"
          echo "=================================="
          echo "ğŸ¯ Target: ${{ secrets.VM_USER }}@${{ secrets.VM_HOST }}"
          echo "ğŸ“… Time: $(date)"
          echo ""
          echo "ğŸ” Check the logs above for:"
          echo "  âœ… All secrets are properly configured"
          echo "  âœ… SSH key format is correct"
          echo "  âœ… Network connectivity works"
          echo "  âœ… SSH connection succeeds"
          echo "  âœ… VM environment is ready"
          echo ""
          echo "If any steps failed, fix those issues before running deployment."
