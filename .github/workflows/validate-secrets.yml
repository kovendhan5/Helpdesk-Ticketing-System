name: üîç Validate GitHub Secrets

on:
  workflow_dispatch: # Manual trigger only

jobs:
  validate-secrets:
    runs-on: ubuntu-latest
    name: üîç Check Required Secrets
    steps:
      - name: Validate All Required Secrets
        run: |
          echo "üîç Validating GitHub Secrets for GCP Deployment..."
          echo "=================================================="
          
          # Check SSH_PRIVATE_KEY
          if [ -n "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "‚úÖ SSH_PRIVATE_KEY: Configured"
            # Check if it looks like a valid SSH key
            if echo "${{ secrets.SSH_PRIVATE_KEY }}" | grep -q "BEGIN.*PRIVATE KEY"; then
              echo "   ‚îî‚îÄ‚îÄ ‚úÖ Appears to be a valid SSH private key"
            else
              echo "   ‚îî‚îÄ‚îÄ ‚ö†Ô∏è  May not be a valid SSH private key format"
            fi
          else
            echo "‚ùå SSH_PRIVATE_KEY: MISSING"
            echo "   ‚îî‚îÄ‚îÄ Add your SSH private key to GitHub Secrets"
          fi
          
          # Check DB_PASSWORD
          if [ -n "${{ secrets.DB_PASSWORD }}" ]; then
            echo "‚úÖ DB_PASSWORD: Configured"
            echo "   ‚îî‚îÄ‚îÄ Length: $(echo '${{ secrets.DB_PASSWORD }}' | wc -c) characters"
          else
            echo "‚ùå DB_PASSWORD: MISSING"
            echo "   ‚îî‚îÄ‚îÄ Add database password to GitHub Secrets"
          fi
          
          # Check JWT_SECRET
          if [ -n "${{ secrets.JWT_SECRET }}" ]; then
            echo "‚úÖ JWT_SECRET: Configured"
            echo "   ‚îî‚îÄ‚îÄ Length: $(echo '${{ secrets.JWT_SECRET }}' | wc -c) characters"
          else
            echo "‚ùå JWT_SECRET: MISSING"
            echo "   ‚îî‚îÄ‚îÄ Add JWT secret to GitHub Secrets"
          fi
          
          # Check REDIS_PASSWORD
          if [ -n "${{ secrets.REDIS_PASSWORD }}" ]; then
            echo "‚úÖ REDIS_PASSWORD: Configured"
            echo "   ‚îî‚îÄ‚îÄ Length: $(echo '${{ secrets.REDIS_PASSWORD }}' | wc -c) characters"
          else
            echo "‚ùå REDIS_PASSWORD: MISSING"
            echo "   ‚îî‚îÄ‚îÄ Add Redis password to GitHub Secrets"
          fi
          
          echo ""
          echo "=================================================="
          
          # Check if all secrets are present
          if [ -n "${{ secrets.SSH_PRIVATE_KEY }}" ] && \
             [ -n "${{ secrets.DB_PASSWORD }}" ] && \
             [ -n "${{ secrets.JWT_SECRET }}" ] && \
             [ -n "${{ secrets.REDIS_PASSWORD }}" ]; then
            echo "üéâ ALL SECRETS CONFIGURED!"
            echo "‚úÖ Ready for GCP deployment"
            echo ""
            echo "Next steps:"
            echo "1. Run the 'Deploy Helpdesk to GCP Production' workflow"
            echo "2. Monitor deployment progress"
            echo "3. Access your app at http://34.173.186.108:8080"
          else
            echo "‚ùå MISSING SECRETS DETECTED"
            echo "üîß Please add the missing secrets before deploying"
            echo ""
            echo "Quick setup:"
            echo "1. Go to: Repository Settings ‚Üí Secrets and variables ‚Üí Actions"
            echo "2. Click 'New repository secret'"
            echo "3. Add each missing secret with the correct name and value"
            echo ""
            echo "Values from your .env file:"
            echo "DB_PASSWORD=mU68QoL8YGh/DTWOHBgFHyF2HliCYH5d"
            echo "JWT_SECRET=NKg9g6243cWlnXHbPBT4TC5eBxghgAYIgRl0bTx1I6rkC/f1aetZdx+PEvLCp82p"
            echo "REDIS_PASSWORD=94ABRM4sG6fppWiIUQRckDIY"
            exit 1
          fi
